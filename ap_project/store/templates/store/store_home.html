{% extends "store/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}صفحه اصلی فروشگاه{% endblock %}

{% block content %}
<!-- استایل‌های مربوط به نمایش کارت (کپی از صفحه‌ی صحیح) -->
<style>
    /* جلوگیری از انتخاب متن هنگام درگ */
    .related-row, .related-row * {
        user-select: none !important;
        -webkit-user-select: none !important;
        -ms-user-select: none !important;
    }

    /* کمک برای درگ و رفتار لمسی */
    .related-row {
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
        cursor: grab;
    }
    .related-row.dragging { cursor: grabbing; }

    /* اطمینان از اینکه کارت‌ها قابل کلیک هستند ولی هنگام درگ غیرفعال می‌شوند */
    .product-card, .related-card { -webkit-user-select: none; user-select: none; }
    .product-card.drag-disable, .related-card.drag-disable { pointer-events: none !important; }

    /* کارت‌های مشابه (ظاهر و هاور و تصویر داخل کادر) */
    .related-card img,
    .product-card.related-card img {
        height: 120px;
        object-fit: contain;
        border-radius: 8px;
        background-color: #fff;
        border: 1px solid #ddd;
        padding: 8px;
        width: 100%;
        display: block;
    }

    .related-card,
    .product-card.related-card {
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        transition: box-shadow 0.3s ease, transform 0.18s ease;
        background: #fff;
        overflow: hidden;
    }

    .related-card:hover,
    .product-card.related-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateY(-4px);
    }

    /* شبکه ریسپانسیو برای جدیدترین محصولات */
    .new-products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(215px, 1fr));
        gap: min(3vw, 22px);
        margin: 0;
    }
    .new-products-grid .product-card.related-card {
        min-width: 0;
        width: 100%;
        max-width: 100%;
        min-height: 230px;
        padding: 0.6rem;
        text-align: center;
        position: relative;
        /* کارت‌ها با عرض صفحه تغییر می‌کنند */
    }

    .product-card.related-card h6 {
        margin-top: .5rem;
        margin-bottom: .25rem;
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .product-card.related-card .price-tag {
        bottom: 38px;
        left: 0;
        margin: 0;
        font-size: 17px;
    }

    .product-card.related-card .bottom-row {
        bottom: 10px;
        left: 0;
        padding: 0 10px;
    }

    .product-card.related-card .badge { font-size: 13px; }
    .product-card.related-card .star { color: #fbc02d; font-size: 16px; }
    .product-card.related-card .rating-val { font-size: 14px; }

</style>

<section>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>جدیدترین محصولات</h5>
        <a href="/products" class="btn btn-sm btn-outline-primary">مشاهده همه</a>
    </div>
    <div class="new-products-grid">
        {% for product in new_products %}
            <div class="product-card related-card text-center position-relative"
                 style="min-width:215px; min-height:230px; cursor:pointer; padding-bottom:60px;"
                onclick="window.location.href='{% url 'product-detail' product.pk %}'">
                <img src="{{ product.image.url }}" alt="{{ product.name }}" />
                <h6 class="mt-2">{{ product.name }}</h6>
                <p class="text-success fw-bold mb-1 position-absolute w-100 price-tag" style="font-size:17px;">
                    {{ product.price|floatformat:0|intcomma }} تومان
                </p>
                <div class="d-flex justify-content-between align-items-center position-absolute w-100 bottom-row" style="padding:0 10px;">
                    <span>
                        {% if product.stock > 0 %}
                            <span class="badge bg-success">موجود</span>
                        {% else %}
                            <span class="badge bg-danger">ناموجود</span>
                        {% endif %}
                    </span>
                    <span class="d-flex align-items-center gap-1">
                        <span class="star">&#9733;</span>
                        <span class="rating-val">{{ product.average_rating|default:0|floatformat:1 }}</span>
                    </span>
                </div>
            </div>
        {% empty %}
            <p>محصولی یافت نشد.</p>
        {% endfor %}
    </div>
</section>

<section class="mt-4">
    <h5>محصولات پیشنهادی برای پوست شما {% if user.profile.skin_type %}({{ user.profile.skin_type }}){% endif %}</h5>
    <div>
        {% if not user.is_authenticated %}
            <p>ابتدا وارد حساب کاربری خود شوید</p>
        {% elif recommended_products %}
            <div class="related-row d-flex overflow-auto gap-3 py-2 mb-3" style="user-select:none;">
                {% for product in recommended_products %}
                    <div class="product-card related-card flex-shrink-0 text-center p-2 position-relative"
                         style="min-width:210px; width:210px; height:230px; cursor:pointer; padding-bottom:60px;"
                         data-href="{% url 'product-detail' product.pk %}">
                        <img src="{{ product.image.url }}" alt="{{ product.name }}">
                        <h6 class="mt-2">{{ product.name }}</h6>
                        <p class="text-success fw-bold mb-1 position-absolute w-100 price-tag" style="font-size:17px;">
                            {{ product.price|floatformat:0|intcomma }} تومان
                        </p>
                        <div class="d-flex justify-content-between align-items-center position-absolute w-100 bottom-row">
                            <span>
                                {% if product.stock > 0 %}
                                    <span class="badge bg-success">موجود</span>
                                {% else %}
                                    <span class="badge bg-danger">ناموجود</span>
                                {% endif %}
                            </span>
                            <span class="d-flex align-items-center gap-1">
                                <span class="star">&#9733;</span>
                                <span class="rating-val">{{ product.average_rating|default:0|floatformat:1 }}</span>
                            </span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>محصول پیشنهادی موجود نیست.</p>
        {% endif %}
    </div>
</section>

<section class="mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>محصولات فصل {{ season }}</h5>
        <a href="{% url 'seasonal-products' %}" class="btn btn-sm btn-outline-primary">مشاهده همه محصولات فصل</a>
    </div>
    <div>
        {% if seasonal_products %}
            <div class="related-row d-flex overflow-auto gap-3 py-2 mb-3" style="user-select:none;">
                {% for product in seasonal_products %}
                    <div class="product-card related-card flex-shrink-0 text-center p-2 position-relative"
                         style="min-width:210px; width:210px; height:230px; cursor:pointer; padding-bottom:60px;"
                         data-href="{% url 'product-detail' product.pk %}">
                        <img src="{{ product.image.url }}" alt="{{ product.name }}">
                        <h6 class="mt-2">{{ product.name }}</h6>
                        <p class="text-success fw-bold mb-1 position-absolute w-100 price-tag" style="font-size:17px;">
                            {{ product.price|floatformat:0|intcomma }} تومان
                        </p>
                        <div class="d-flex justify-content-between align-items-center position-absolute w-100 bottom-row">
                            <span>
                                {% if product.stock > 0 %}
                                    <span class="badge bg-success">موجود</span>
                                {% else %}
                                    <span class="badge bg-danger">ناموجود</span>
                                {% endif %}
                            </span>
                            <span class="d-flex align-items-center gap-1">
                                <span class="star">&#9733;</span>
                                <span class="rating-val">{{ product.average_rating|default:0|floatformat:1 }}</span>
                            </span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>محصول فصلی‌ای یافت نشد.</p>
        {% endif %}
    </div>
</section>

<section class="mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>محصولات مورد علاقه شما</h5>
        <a href="{% url 'favorites-list' %}" class="btn btn-sm btn-outline-primary">نمایش همه علاقه‌مندی‌ها</a>
    </div>

    <div>
        {% if not user.is_authenticated %}
            <p>ابتدا وارد حساب کاربری خود شوید</p>
        {% elif liked_favorites %}
            <div class="related-row d-flex overflow-auto gap-3 py-2 mb-3" style="user-select:none;">
                {% for product in liked_favorites|slice:":10" %}
                    <div class="product-card related-card flex-shrink-0 text-center p-2 position-relative"
                         style="min-width:210px; width:210px; height:230px; cursor:pointer; padding-bottom:60px;"
                         data-href="{% url 'product-detail' product.pk %}">
                        <img src="{{ product.image.url }}" alt="{{ product.name }}">
                        <h6 class="mt-2">{{ product.name }}</h6>
                        <p class="text-success fw-bold mb-1 position-absolute w-100 price-tag" style="font-size:17px;">
                            {{ product.price|floatformat:0|intcomma }} تومان
                        </p>
                        <div class="d-flex justify-content-between align-items-center position-absolute w-100 bottom-row">
                            <span>
                                {% if product.stock > 0 %}
                                    <span class="badge bg-success">موجود</span>
                                {% else %}
                                    <span class="badge bg-danger">ناموجود</span>
                                {% endif %}
                            </span>
                            <span class="d-flex align-items-center gap-1">
                                <span class="star">&#9733;</span>
                                <span class="rating-val">{{ product.average_rating|default:0|floatformat:1 }}</span>
                            </span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>محصول مورد علاقه‌ای یافت نشد.</p>
        {% endif %}
    </div>

</section>
{% endblock %}

{% block _scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {

  // helper مطمئن برای باز کردن در تب جدید (اول window.open، سپس fallback با <a>)
  function openInNewTab(url) {
    try {
      const w = window.open(url, '_blank', 'noopener,noreferrer');
      if (w) return true;
    } catch (err) { /* ignore */ }

    try {
      const a = document.createElement('a');
      a.href = url;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      const ev = new MouseEvent('click', { bubbles: true, cancelable: true, view: window });
      a.dispatchEvent(ev);
      a.remove();
      return true;
    } catch (err) {
      return false;
    }
  }

  // تابع عمومی برای اضافه کردن contextmenu handler به کارت‌ها (محافظت در برابر درگ/کلیک)
  function addContextHandlerToCard(card) {
    if (card._rc_handler_added) return;
    card._rc_handler_added = true;

    card.addEventListener('contextmenu', function(e) {
      // جلوگیری از منوی پیشفرض و جلوگیری از اجرای هاندلرهای دیگر
      e.preventDefault();
      e.stopImmediatePropagation();
      e.stopPropagation();

      // چک‌های حفاظتی (اگر کارت در حالت drag-disable یا درگ یا کلیک سرکوبی وجود دارد، نپریم)
      let row = card.closest('.related-row');
      let isDragging = false, suppressClick = false;
      if (row && typeof row.__dragState !== 'undefined') {
        ({ isDragging = false, suppressClick = false } = row.__dragState);
      } else {
        if (card.classList.contains('drag-disable')) return;
      }

      if (isDragging || suppressClick || card.classList.contains('drag-disable')) {
        return;
      }

      const href = card.getAttribute('data-href') || card.dataset.href || (card.getAttribute('onclick') && (card.getAttribute('onclick').match(/window\.location\.href\s*=\s*['"]([^'"]+)['"]/)||[])[1]);
      if (!href) return;

      if (card._rc_opened) return;
      card._rc_opened = true;

      openInNewTab(href);
      setTimeout(() => { card._rc_opened = false; }, 300);
      return;
    }, false);
  }

  // -------- related-row logic (اصلاح شده برای نادیده گرفتن دکمه‌های غیر چپ) --------
  document.querySelectorAll('.related-row').forEach(function (row, idx) {

    const MOVE_THRESHOLD = 8;
    const SUPPRESS_MS = 250;

    let pointerActive = false;
    let activePointerId = null;
    let startX = 0, startY = 0;
    let lastScrollLeft = 0;
    let isDragging = false;
    let suppressClick = false;
    let suppressTimer = null;

    // نگهداری state روی ردیف تا handlerهای contextmenu به آن دسترسی داشته باشند
    // (استفاده از getterها تا همیشه مقدارِ واقعی خوانده شود)
    row.__dragState = {
      get isDragging() { return isDragging; },
      get suppressClick() { return suppressClick; }
    };

    row.querySelectorAll('img').forEach(img => img.setAttribute('draggable', 'false'));

    function setChildPointerEventsDisabled(disabled) {
      row.querySelectorAll('.product-card, .related-card').forEach(function(c) {
        c.classList.toggle('drag-disable', disabled);
      });
    }

    row.querySelectorAll('.product-card, .related-card').forEach(function(card, cidx) {

      // === مهم: روی pointerup فقط وقتی دکمهٔ چپ است اجازهٔ ناوبری بدهیم ===
      card.addEventListener('pointerup', function(e) {
        // اگر موس و دکمه غیر از چپ است، نپریم (مثلاً راست کلیک)
        if (e.pointerType === 'mouse' && e.button !== 0) return;
        if (isDragging) return;
        if (suppressClick) return;
        const href = card.getAttribute('data-href') || card.dataset.href;
        if (href) {
          window.location.href = href;
        }
      });

      card.addEventListener('click', function(e) {
        // کلیک معمولاً دکمهٔ چپ است؛ اگر درگ یا سرکوب فعال است جلوگیری کن
        if (isDragging || suppressClick) {
          e.preventDefault();
          e.stopImmediatePropagation();
          return;
        }
        const href = card.getAttribute('data-href') || card.dataset.href;
        if (href) {
          window.location.href = href;
        }
      }, true);

      // اضافه کردن handler راست‌کلیک فقط به کارت‌های داخل related-row
      addContextHandlerToCard(card);
    });

    row.addEventListener('pointerdown', function (e) {
      // اگر موس و دکمه غیر از چپ است، این رویداد را نادیده بگیر (تا راست‌کلیک در اسکرول دخالتی نکند)
      if (e.pointerType === 'mouse' && e.button !== 0) return;
      pointerActive = true;
      activePointerId = e.pointerId;
      startX = e.clientX;
      startY = e.clientY;
      lastScrollLeft = row.scrollLeft;
      isDragging = false;
      try { row.setPointerCapture(activePointerId); } catch(_) {}
      row.classList.add('dragging');
      document.body.style.userSelect = 'none';
    }, { passive: true });

    row.addEventListener('pointermove', function (e) {
      if (!pointerActive || e.pointerId !== activePointerId) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      if (Math.abs(dx) > MOVE_THRESHOLD && Math.abs(dx) > Math.abs(dy)) {
        isDragging = true;
        setChildPointerEventsDisabled(true);
        row.scrollLeft = lastScrollLeft - dx * 1.2;
      }
      if (isDragging) {
        e.preventDefault && e.preventDefault();
      }
    }, { passive: false });

    function finishPointer(e) {
      if (!pointerActive) return;
      try { if (activePointerId !== null) row.releasePointerCapture(activePointerId); } catch(_) {}
      pointerActive = false;
      activePointerId = null;
      row.classList.remove('dragging');
      setChildPointerEventsDisabled(false);
      document.body.style.userSelect = '';
      if (isDragging) {
        suppressClick = true;
        clearTimeout(suppressTimer);
        suppressTimer = setTimeout(() => {
          suppressClick = false;
          console.log("⏱ suppressClick خاموش شد");
        }, SUPPRESS_MS);
      }
      isDragging = false;
    }

    // === row-level pointerup: اگر موس و دکمه غیر از چپ است، فقط cleanup کن و از ناوبری جلوگیری کن ===
    row.addEventListener('pointerup', function (e) {
      // اگر موس و دکمه غیر از چپ است، اجازه ندهیم ناوبری انجام شود
      if (e.pointerType === 'mouse' && e.button !== 0) {
        // فقط cleanup لازم است (finishPointer خودش با pointerActive کار می‌کند)
        finishPointer(e);
        return;
      }

      const wasDragging = isDragging;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      const moved = Math.hypot(dx, dy);
      finishPointer(e);

      if (!wasDragging && moved <= MOVE_THRESHOLD && !suppressClick) {
        const el = document.elementFromPoint(e.clientX, e.clientY);
        const card = el && el.closest ? el.closest('.product-card, .related-card') : null;
        if (card) {
          if (card.classList.contains('drag-disable')) {
            return;
          }
          const href = card.getAttribute('data-href') || card.dataset.href;
          if (href) {
            window.location.href = href;
          }
        }
      }
    }, { passive: true });

    row.addEventListener('pointercancel', finishPointer);
    row.addEventListener('pointerleave', finishPointer);

    row.addEventListener('click', function (e) {
      if (suppressClick) {
        e.stopImmediatePropagation();
        e.preventDefault();
      }
    }, true);

    row.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' || e.key === ' ') {
        const focused = document.activeElement;
        const card = focused && focused.closest ? focused.closest('.product-card, .related-card') : null;
        if (card) {
          const href = card.getAttribute('data-href') || card.dataset.href;
          if (href) {
            window.location.href = href;
            e.preventDefault();
          }
        }
      }
    });

  }); // related-row forEach

  // -------- اضافه: کارت‌های بخش new-products-grid (grid ساده) --------
  document.querySelectorAll('.new-products-grid .product-card.related-card').forEach(function(card) {
    // جلوگیری از انتخاب متن
    card.querySelectorAll('img').forEach(img => img.setAttribute('draggable', 'false'));

    // اگر کارت با onclick inline دارد، دیتا-اچ‌رف را نیز بگذار تا handler بتواند بخواند
    if (!card.getAttribute('data-href')) {
      const onclick = card.getAttribute('onclick');
      if (onclick) {
        const m = onclick.match(/window\.location\.href\s*=\s*['"]([^'"]+)['"]/);
        if (m && m[1]) {
          card.setAttribute('data-href', m[1]);
        }
      }
    }

    // handler راست‌کلیکِ مخصوص این کارت‌ها (بدون درگ پیچیده)
    addContextHandlerToCard(card);
  });

});
</script>
{% endblock %}
