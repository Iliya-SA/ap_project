{% extends 'store/base.html' %}
{% load humanize %}
{% block title %}{{ product.name }} - فروشگاه لوازم آرایشی{% endblock %}
{% block content %}
    <style>
    /* جلوگیری از انتخاب متن هنگام درگ */
    .related-row, .related-row * {
        user-select: none !important;
        -webkit-user-select: none !important;
        -ms-user-select: none !important;
    }

    /* کمک برای درگ و رفتار لمسی */
    .related-row {
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
        cursor: grab;
    }
    .related-row.dragging { cursor: grabbing; }

    /* اطمینان از اینکه کارت‌ها قابل کلیک هستند ولی هنگام درگ غیرفعال می‌شوند */
    .product-card, .related-card { -webkit-user-select: none; user-select: none; }
    .product-card.drag-disable, .related-card.drag-disable { pointer-events: none !important; }

    /* کارت‌های مشابه (ظاهر و هاور و تصویر داخل کادر) */
    .related-card img,
    .product-card.related-card img {
        height: 120px;
        object-fit: contain;
        border-radius: 8px;
        background-color: #fff;
        border: 1px solid #ddd;
        padding: 8px;
        width: 100%;
        display: block;
    }

    .related-card,
    .product-card.related-card {
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        transition: box-shadow 0.3s ease, transform 0.18s ease;
        background: #fff;
        overflow: hidden;
    }

    .related-card:hover,
    .product-card.related-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateY(-4px);
    }

    .product-card.related-card h6 {
        margin-top: .5rem;
        margin-bottom: .25rem;
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .product-card.related-card .price-tag {
        bottom: 38px;
        left: 0;
        margin: 0;
        font-size: 17px;
    }

    .product-card.related-card .bottom-row {
        bottom: 10px;
        left: 0;
        padding: 0 10px;
    }

    .product-card.related-card .badge { font-size: 13px; }
    .product-card.related-card .star { color: #fbc02d; font-size: 16px; }
    .product-card.related-card .rating-val { font-size: 14px; }

    /* small enhancement: smoother momentum on iOS */
    .related-row { -webkit-overflow-scrolling: touch; }

    .top-navbar {
        background-color: #e8f4fc;
        padding: 10px 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .top-navbar a {
        color: #0d6efd;
        font-weight: 600;
        text-decoration: none;
        padding: 8px 18px;
        border-radius: 30px;
        border: 1px solid #0d6efd;
        background-color: white;
        transition: all 0.3s ease;
    }

    .top-navbar a:hover {
        background-color: #d0e7ff;
    }

    .favorite-link {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 15px;
        font-weight: 500;
        color: #e91e63;
    }

    .favorite-link:hover {
        color: #c2185b;
    }

    .favorite-link .heart {
        font-size: 18px;
    }

    .product-image {
        max-height: 350px;
        object-fit: contain;
        border-radius: 10px;
        border: 1px solid #ddd;
        background-color: #fff;
        padding: 10px;
        width: 100%;
    }

    .star-icon {
        color: #fbc02d;
        font-size: 20px;
        vertical-align: middle;
    }
    .user-name {
        font-size: 1.2rem;
        color: #007bff;
        font-weight: bold;
    }

    .price-text {
        color: #1b5e20;
        font-weight: 700;
        font-size: 28px;
    }

    .btn-buy {
        font-size: 18px;
        padding: 10px;
    }

    .related-card {
        min-width: 210px;
        width: 210px;
        height: 230px;
        box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
        border-radius: 8px;
        transition: box-shadow 0.3s ease, transform 0.18s ease;
        background: #fff;
        overflow: hidden;
        position: relative;
        padding: 8px;
        text-align: center;
        cursor: pointer;
    }
    .related-card:hover {
        box-shadow: 0 4px 12px rgb(0 0 0 / 0.15);
        transform: translateY(-4px);
        cursor: pointer;
    }
    .related-row.dragging .related-card {
        cursor: grabbing !important;
    }
    .related-card img {
        height: 120px;
        object-fit: contain;
        border-radius: 8px;
        background-color: #fff;
        border: 1px solid #ddd;
        padding: 8px;
        width: 100%;
        display: block;
    }
    .related-card:hover {
        box-shadow: 0 4px 12px rgb(0 0 0 / 0.15);
        transform: translateY(-4px);
    }

    .comments-section {
        max-width: 100%;
    }

    .comment-item {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 1px 5px rgb(0 0 0 / 0.05);
        margin-bottom: 15px;
        padding: 15px;
    }

    .comment-header {
        font-weight: 600;
        margin-bottom: 5px;
    }

    .comment-date {
        font-size: 12px;
        color: #999;
    }
    </style>
</head>
<body>

<main class="container my-4">
{% block extra_scripts %}
<script>
// ثبت بازدید محصول به محض لود صفحه (فقط برای کاربران لاگین)
document.addEventListener('DOMContentLoaded', function() {
    {% if user.is_authenticated %}
    fetch('{% url "add-visited-product" product.pk %}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    });
    {% endif %}
});
</script>
{% endblock %}
    <!-- نوار بالا با علاقه‌مندی -->
    <nav class="top-navbar">
        <a href="#" onclick="history.back(); return false;">بازگشت</a>
        {% if user.is_authenticated %}
            <a href="#" id="favorite-btn" class="favorite-link" data-url="{% url 'toggle-favorite' product.pk %}">
                <span class="heart">{% if is_favorite %}❤️{% else %}🤍{% endif %}</span>
                علاقه‌مندی
            </a>
        {% else %}
            <a href="{% url 'signin' %}?next={% url 'product-detail' product.pk %}" class="favorite-link">🤍 علاقه‌مندی</a>
        {% endif %}
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            var favBtn = document.getElementById('favorite-btn');
            favBtn.addEventListener('click', function(e) {
                e.preventDefault();
                fetch(favBtn.getAttribute('data-url'), {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    favBtn.querySelector('.heart').textContent = data.is_favorite ? '❤️' : '🤍';
                });
            });
        });
        </script>
    </nav>

    <!-- بخش محصول -->
    <div class="row g-4 bg-white p-4 rounded shadow-sm">
        <div class="col-md-5">
            {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image" />
            {% else %}
                <div class="d-flex justify-content-center align-items-center bg-secondary text-white rounded" style="height: 350px;">
                    تصویر موجود نیست
                </div>
            {% endif %}
        </div>
        <div class="col-md-7 d-flex flex-column justify-content-between">
            <div>
                <h1 class="fw-bold">{{ product.name }}</h1>
                <h5 class="text-muted">{{ product.brand }}</h5>
                <p><strong>دسته‌بندی:</strong> {{ product.category }}</p>
                <p>{{ product.description }}</p>
                <p><strong>مناسب برای پوست‌های:</strong> {{ skin_type_str }}</p>

                <div class="my-3 fs-5">
                    <span class="star-icon">★</span>
                    <span class="fw-bold">{{ product.average_rating|floatformat:1 }}</span>
                </div>

                <p class="price-text">{{ product.price|floatformat:0|intcomma }} تومان</p>
            </div>
            {% if user.is_authenticated %}
                <div class="d-flex gap-2 mt-3">
                    {% if in_cart %}
                        <div class="input-group" style="max-width:140px;">
                            <button class="btn btn-outline-secondary" type="button" id="dec-qty">-</button>
                            <input type="number" min="1" id="product-qty" value="{{ in_cart_quantity }}" class="form-control text-center" />
                            <button class="btn btn-outline-secondary" type="button" id="inc-qty">+</button>
                        </div>
                        <button id="remove-from-cart-btn" data-item-id="{{ cart_item_id }}" class="btn btn-danger btn-buy">حذف از سبد خرید</button>
                    {% else %}
                        <button id="add-to-cart-btn" data-url="{% url 'add-to-cart' product.pk %}" class="btn btn-success btn-buy w-100">افزودن به سبد خرید</button>
                    {% endif %}
                </div>
                <!-- نمایش تعداد فعلی در سبد حذف شد -->
            {% else %}
                <a href="{% url 'signin' %}?next={% url 'product-detail' product.pk %}" class="btn btn-success btn-buy mt-3 w-100">افزودن به سبد خرید</a>
            {% endif %}
        </div>
    </div>

    <!-- toast container -->
    <div id="cart-toast" style="position: fixed; left: 20px; bottom: 20px; z-index: 1060; display:none;">
        <div class="toast align-items-center text-bg-success border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    محصول به سبد خرید شما اضافه شد
                </div>
                <div class="toast-footer p-2">
                    <a href="{% url 'cart-detail' %}" class="btn btn-light me-2" style="min-width:160px; padding:0.5rem 0.9rem;">رفتن به سبد خرید</a>
                    <!-- close button visually removed but kept hidden so JS that binds to #close-toast doesn't error -->
                    <button type="button" id="close-toast" class="btn btn-sm btn-outline-light" style="display:none;">بستن</button>
                </div>
            </div>
        </div>
    </div>


    <!-- محصولات مرتبط -->
    <section class="mt-5">
        <h4 class="mb-3" style="font-weight:600;">محصولات مشابه این محصول</h4>
        <div class="related-row d-flex overflow-auto gap-3 py-2">
            {% for similar in similar_products %}
            <div class="product-card related-card flex-shrink-0" data-href="{% url 'product-detail' similar.pk %}">
                <img src="{{ similar.image.url }}" alt="{{ similar.name }}">
                <h6 class="mt-2" style="margin-top:.5rem; margin-bottom:.25rem; font-size:0.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ similar.name }}</h6>
                <p class="text-success fw-bold mb-1 w-100 price-tag" style="font-size:17px; position:absolute; bottom:38px; left:0; margin:0;">{{ similar.price|floatformat:0|intcomma }} تومان</p>
                <div class="d-flex justify-content-between align-items-center w-100 bottom-row" style="position:absolute; bottom:10px; left:0; padding:0 10px;">
                                    <span>
                                        {% if similar.stock > 0 %}
                                            <span class="badge bg-success" style="font-size:13px;">موجود</span>
                                        {% else %}
                                            <span class="badge bg-danger" style="font-size:13px;">ناموجود</span>
                                        {% endif %}
                                    </span>
                                    <span class="d-flex align-items-center gap-1">
                                        <span style="color: #fbc02d; font-size: 16px;">&#9733;</span>
                                        <span style="font-size:14px;">{{ similar.average_rating|default:0|floatformat:1 }}</span>
                                    </span>
                                </div>
            </div>
            {% empty %}
            <p class="text-muted">محصول مشابهی وجود ندارد.</p>
            {% endfor %}
        </div>
    </section>

    <!-- دیگر محصولات برند -->
    <section class="mt-5">
        <h4 class="mb-3" style="font-weight:600;">دیگر محصولات برند {{ product.brand }}</h4>
        <div class="related-row d-flex overflow-auto gap-3 py-2">
            {% for brand_item in brand_products %}
            <div class="product-card related-card flex-shrink-0" data-href="{% url 'product-detail' brand_item.pk %}">
                <img src="{{ brand_item.image.url }}" alt="{{ brand_item.name }}">
                <h6 class="mt-2" style="margin-top:.5rem; margin-bottom:.25rem; font-size:0.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ brand_item.name }}</h6>
                <p class="text-success fw-bold mb-1 w-100 price-tag" style="font-size:17px; position:absolute; bottom:38px; left:0; margin:0;">{{ brand_item.price|floatformat:0|intcomma }} تومان</p>
                <div class="d-flex justify-content-between align-items-center w-100 bottom-row" style="position:absolute; bottom:10px; left:0; padding:0 10px;">
                                    <span>
                                        {% if brand_item.stock > 0 %}
                                            <span class="badge bg-success" style="font-size:13px;">موجود</span>
                                        {% else %}
                                            <span class="badge bg-danger" style="font-size:13px;">ناموجود</span>
                                        {% endif %}
                                    </span>
                                    <span class="d-flex align-items-center gap-1">
                                        <span style="color: #fbc02d; font-size: 16px;">&#9733;</span>
                                        <span style="font-size:14px;">{{ brand_item.average_rating|default:0|floatformat:1 }}</span>
                                    </span>
                                </div>
            </div>
            {% empty %}
            <p class="text-muted">محصول دیگری از این برند وجود ندارد.</p>
            {% endfor %}
        </div>
    </section>

<script>
document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('add-to-cart-btn');
    var qtyInput = document.getElementById('product-qty');
    var incBtn = document.getElementById('inc-qty');
    var decBtn = document.getElementById('dec-qty');
    // in-cart count display removed per UX request
    // cart item id from context (may be empty string)
    var cartItemId = '{{ cart_item_id|default:"" }}';

    if (incBtn) incBtn.addEventListener('click', function(){
        qtyInput.value = Math.max(1, parseInt(qtyInput.value || '1') + 1);
        // if this product already has a cart item, notify server about quantity change
        if(cartItemId){
            sendQtyUpdateToServer(cartItemId, qtyInput.value);
        }
    });
    if (decBtn) decBtn.addEventListener('click', function(){
        qtyInput.value = Math.max(1, parseInt(qtyInput.value || '1') - 1);
        if(cartItemId){
            sendQtyUpdateToServer(cartItemId, qtyInput.value);
        }
    });

    // helper to send quantity update to server and update UI
    function sendQtyUpdateToServer(itemId, qty){
        if(!itemId) return;
        var body = new URLSearchParams();
        body.append('quantity_' + itemId, qty);
        fetch('{% url "update-cart" %}', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: body
        }).then(r => r.json()).then(function(d){
            if(d){
                if(d.item_quantity !== undefined && inCartSpan){
                    inCartSpan.textContent = d.item_quantity;
                }
                if(d.cart_total !== undefined){
                    var totalSection = document.querySelector('.total-section');
                    if(totalSection) totalSection.innerHTML = 'جمع کل: ' + Number(d.cart_total).toLocaleString() + ' تومان';
                }
            }
        }).catch(function(e){ console.error(e); });
    }

    // if qty input exists on page load (product already in cart), attach change handler
    if(qtyInput && cartItemId){
        qtyInput.addEventListener('change', function(){
            sendQtyUpdateToServer(cartItemId, qtyInput.value);
        });
    }

    if (btn) {
        btn.addEventListener('click', function(){
            var url = btn.getAttribute('data-url');
            var qty = parseInt(qtyInput ? qtyInput.value : 1) || 1;
            var body = new URLSearchParams();
            body.append('quantity', qty);

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: body
            }).then(response => response.json())
            .then(data => {
                // update in-cart count from server
                    if(data && data.item_quantity !== undefined){
                    showCartToast(data.item_quantity);

                    // replace add button with a container that has qty selector + remove button
                    var addBtn = document.getElementById('add-to-cart-btn');
                    if(addBtn){
                        var parent = addBtn.parentNode;
                        var container = document.createElement('div');
                        container.className = 'd-flex gap-2 mt-3';

                        // create input group
                        var inputGroup = document.createElement('div');
                        inputGroup.className = 'input-group';
                        inputGroup.style.maxWidth = '140px';

                        var dec = document.createElement('button');
                        dec.className = 'btn btn-outline-secondary';
                        dec.type = 'button';
                        dec.id = 'dec-qty';
                        dec.textContent = '-';

                        var qtyInp = document.createElement('input');
                        qtyInp.type = 'number';
                        qtyInp.min = '1';
                        qtyInp.id = 'product-qty';
                        qtyInp.className = 'form-control text-center';
                        qtyInp.value = data.item_quantity;

                        var inc = document.createElement('button');
                        inc.className = 'btn btn-outline-secondary';
                        inc.type = 'button';
                        inc.id = 'inc-qty';
                        inc.textContent = '+';

                        inputGroup.appendChild(dec);
                        inputGroup.appendChild(qtyInp);
                        inputGroup.appendChild(inc);

                        var removeBtn = document.createElement('button');
                        removeBtn.id = 'remove-from-cart-btn';
                        removeBtn.className = 'btn btn-danger btn-buy';
                        removeBtn.textContent = 'حذف از سبد خرید';
                        if(data.item_id) {
                            removeBtn.setAttribute('data-item-id', data.item_id);
                            // expose globally for other handlers
                            cartItemId = String(data.item_id);
                        }

                        container.appendChild(inputGroup);
                        container.appendChild(removeBtn);

                        parent.replaceChild(container, addBtn);

                        // attach inc/dec handlers
                        inc.addEventListener('click', function(){
                            qtyInp.value = Math.max(1, parseInt(qtyInp.value || '1') + 1);
                            // trigger change so server is notified
                            qtyInp.dispatchEvent(new Event('change'));
                        });
                        dec.addEventListener('click', function(){
                            qtyInp.value = Math.max(1, parseInt(qtyInp.value || '1') - 1);
                            qtyInp.dispatchEvent(new Event('change'));
                        });

                        // when qty changes, send update to server (reuse update-cart endpoint)
                        qtyInp.addEventListener('change', function(){
                            var itemId = removeBtn.getAttribute('data-item-id');
                            if(!itemId) return;
                            var body3 = new URLSearchParams();
                            body3.append('quantity_' + itemId, qtyInp.value);
                            fetch('{% url "update-cart" %}', {
                                method: 'POST',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: body3
                            }).then(r => r.json()).then(d => {
                                if(d && d.cart_total !== undefined){
                                    var totalSection = document.querySelector('.total-section');
                                    if(totalSection) totalSection.innerHTML = 'جمع کل: ' + Number(d.cart_total).toLocaleString() + ' تومان';
                                }
                            }).catch(()=>{});
                        });

                        // remove handler reloads page after server update
                        removeBtn.addEventListener('click', function(){
                            var itemId = removeBtn.getAttribute('data-item-id');
                            var body2 = new URLSearchParams();
                            if(itemId){
                                body2.append('quantity_' + itemId, '0');
                                fetch('{% url "update-cart" %}', {
                                    method: 'POST',
                                    headers: {
                                        'X-Requested-With': 'XMLHttpRequest',
                                        'X-CSRFToken': '{{ csrf_token }}'
                                    },
                                    body: body2
                                }).finally(function(){ location.reload(); });
                            } else {
                                // fallback: reload
                                location.reload();
                            }
                        });
                    }
                } else {
                    showCartToast();
                }
            }).catch(err => {
                console.error(err);
            });
        });
    }

    // handle explicit remove button if page loaded with product in cart
    var explicitRemove = document.getElementById('remove-from-cart-btn');
    if(explicitRemove){
        explicitRemove.addEventListener('click', function(){
            var itemId = explicitRemove.getAttribute('data-item-id');
            var body2 = new URLSearchParams();
            if(itemId){
                body2.append('quantity_' + itemId, '0');
                fetch('{% url "update-cart" %}', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: body2
                }).finally(function(){ location.reload(); });
            }
        });
    }

    function showCartToast(newQty){
        var toast = document.getElementById('cart-toast');
        if(!toast) return;
        // update message
        if(newQty !== undefined){
            var body = toast.querySelector('.toast-body');
            if(body) body.textContent = 'محصول به سبد خرید شما اضافه شد';
        }
        toast.style.display = 'block';
        // auto hide after 5 seconds
        var timeout = setTimeout(hideToast, 5000);
        document.getElementById('close-toast').addEventListener('click', function(){
            clearTimeout(timeout);
            hideToast();
        });
        function hideToast(){
            toast.style.display = 'none';
        }
    }
});
</script>

    <!-- نظرات -->
    <section class="comments-section mt-5">
        <h3>نظرات اخیر</h3>
        {% if recent_comments %}
            {% for comment in recent_comments|slice:":5" %}
            <div class="comment-item position-relative" dir="rtl">
                {% if user.is_authenticated and comment.user.id == user.id %}
                    <form method="post" action="{% url 'delete-comment' comment.pk %}" class="delete-comment-form" style="position:absolute; left:12px; top:12px; z-index:2;">
                    {% csrf_token %}
                    <!-- برای کاربران بدون JS: دکمه‌ی submit داخل noscript -->
                    <noscript>
                        <button type="submit" class="btn btn-sm btn-danger">حذف</button>
                    </noscript>

                    <!-- دکمه‌ی قابل کلیک توسط JS (type=button مانع submit طبیعی می‌شود) -->
                    <button type="button"
                            class="btn btn-sm btn-danger ajax-delete-comment"
                            data-url="{% url 'delete-comment' comment.pk %}">
                        حذف
                    </button>
                    </form>
                {% endif %}
                <div class="d-flex align-items-center mb-2 justify-content-start" style="text-align:right;">
                    <span class="star-icon ms-2">★ {{ comment.rating }}</span>
                    <span class="user-name">{{ comment.user.user.first_name }} {{ comment.user.user.last_name }}</span>
                </div>
                <div class="comment-text mb-1">{{ comment.text }}</div>
                <div class="comment-date">{{ comment.created_at|date:"Y/m/d H:i" }}</div>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">هیچ نظری ثبت نشده است.</p>
        {% endif %}

        <div class="d-flex gap-2 mt-3 align-items-start">
            <a href="{% url 'product-comments' product.pk %}" class="btn btn-outline-secondary">مشاهده همه نظرات</a>

            <!-- Inline comment form (AJAX) -->
            {% if user.is_authenticated %}
            <form id="inline-comment-form" class="d-flex gap-2 align-items-center" method="post" action="{% url 'add-comment' product.pk %}">
                {% csrf_token %}
                <select name="rating" id="rating" class="form-select form-select-sm" style="width:90px;">
                    <option value="5">5 ★</option>
                    <option value="4">4 ★</option>
                    <option value="3">3 ★</option>
                    <option value="2">2 ★</option>
                    <option value="1">1 ★</option>
                </select>
                <textarea name="text" id="comment-text" class="form-control form-control-sm" rows="1" placeholder="نظر خود را بنویسید..." style="min-width:calc(30vw);"></textarea>
                <button type="submit" id="submit-comment" class="btn btn-success btn-sm">ثبت</button>
            </form>
            {% else %}
                <a href="{% url 'signin' %}?next={% url 'product-detail' product.pk %}" class="btn btn-success">برای ثبت نظر وارد شوید</a>
            {% endif %}
        </div>

        <div id="inline-comments-container"></div>
    </section>


</main>

</body>
<script>
// AJAX delete via button click — avoids any submit-based handlers so no reload
document.addEventListener('DOMContentLoaded', function () {
  document.addEventListener('click', async function (ev) {
    const btn = ev.target.closest && ev.target.closest('.ajax-delete-comment');
    if (!btn) return;

    ev.preventDefault();
    ev.stopImmediatePropagation(); // try to stop other click handlers

    if (!confirm('آیا از حذف نظر خود مطمئن هستید؟')) return;

    const url = btn.getAttribute('data-url');
    // try to find CSRF token from the same form
    const form = btn.closest('form');
    const csrfInput = form ? form.querySelector('input[name="csrfmiddlewaretoken"]') : null;
    const csrf = csrfInput ? csrfInput.value : null;

    // disable button to avoid double clicks
    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = 'در حال حذف...';

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          ...(csrf ? {'X-CSRFToken': csrf} : {})
        }
      });

      if (!res.ok) {
        let txt = '';
        try { txt = await res.text(); } catch(_) {}
        throw new Error('حذف ناموفق: ' + res.status + ' ' + txt);
      }

      // حذف DOM کامنت
      const commentDiv = btn.closest('.comment-item') || btn.closest('.comment') || form.closest('.comment-item') || form;
      if (commentDiv) commentDiv.remove();

    } catch (err) {
      console.error('AJAX delete error:', err);
      alert('حذف نظر ناموفق بود. دوباره تلاش کنید.');
      btn.disabled = false;
      btn.textContent = originalText;
    }
  }, true); // use capture to be early
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // باز کردن در تب جدید با fallback
  function openInNewTab(url) {
    try {
      const w = window.open(url, '_blank', 'noopener,noreferrer');
      if (w) return true;
    } catch (_) {}
    try {
      const a = document.createElement('a');
      a.href = url;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      const ev = new MouseEvent('click', { bubbles: true, cancelable: true, view: window });
      a.dispatchEvent(ev);
      a.remove();
      return true;
    } catch (_) { return false; }
  }

  // handler راست‌کلیک محافظت‌شده برای یک کارت
  function addContextHandlerToCard(card) {
    if (!card || card._rc_handler_added) return;
    card._rc_handler_added = true;

    card.addEventListener('contextmenu', function (e) {
      // جلوگیری از منوی پیشفرض و جلوگیری از اجرای handlerهای دیگر
      e.preventDefault();
      e.stopImmediatePropagation();
      e.stopPropagation();

      // اگر کارت در حالت drag-disable یا ردیف درگ هست، نپریم
      const row = card.closest('.related-row');
      let isDragging = false, suppressClick = false;
      if (row && typeof row.__dragState !== 'undefined') {
        try {
          isDragging = !!row.__dragState.isDragging;
          suppressClick = !!row.__dragState.suppressClick;
        } catch (_) {}
      }
      if (isDragging || suppressClick || card.classList.contains('drag-disable')) return;

      // استخراج href از data-href یا onclick inline
      let href = card.getAttribute('data-href') || card.dataset.href;
      if (!href) {
        const onclick = card.getAttribute('onclick');
        if (onclick) {
          const m = onclick.match(/window\.location\.href\s*=\s*['"]([^'"]+)['"]/);
          if (m && m[1]) href = m[1];
        }
      }
      if (!href) return;

      if (card._rc_opened) return;
      card._rc_opened = true;
      openInNewTab(href);
      setTimeout(() => { card._rc_opened = false; }, 300);
    }, false);
  }

  // اصلی: پیاده‌سازی درگ-اسکرول با pointer events برای هر related-row
  document.querySelectorAll('.related-row').forEach(function (row) {
    const MOVE_THRESHOLD = 8;
    const SUPPRESS_MS = 220;

    let pointerActive = false;
    let activePointerId = null;
    let startX = 0, startY = 0;
    let lastScrollLeft = 0;
    let isDragging = false;
    let suppressClick = false;
    let suppressTimer = null;
    let ticking = false;
    let targetScrollLeft = 0;

    // expose state قابل خواندن برای contextmenu handlers
    Object.defineProperty(row, '__dragState', {
      get: function () { return { isDragging: isDragging, suppressClick: suppressClick }; },
      configurable: true
    });

    // جلوگیری از ghost image
    row.querySelectorAll('img').forEach(img => img.setAttribute('draggable', 'false'));

    function setChildPointerEventsDisabled(disabled) {
      row.querySelectorAll('.product-card, .related-card').forEach(function (c) {
        c.classList.toggle('drag-disable', disabled);
      });
    }

    // ثبت listenerها برای کارت‌ها (تک‌کلیک امن + contextmenu)
    row.querySelectorAll('.product-card, .related-card').forEach(function (card) {
      // pointerup: فقط اگر button چپ (یا لمسی) باشد
      card.addEventListener('pointerup', function (e) {
        if (e.pointerType === 'mouse' && e.button !== 0) return;
        if (isDragging || suppressClick) return;
        const href = card.getAttribute('data-href') || card.dataset.href;
        if (href) window.location.href = href;
      });

      // fallback click
      card.addEventListener('click', function (e) {
        if (isDragging || suppressClick) {
          e.preventDefault();
          e.stopImmediatePropagation();
          return;
        }
        if (typeof e.button !== 'undefined' && e.button !== 0) return;
        const href = card.getAttribute('data-href') || card.dataset.href;
        if (href) window.location.href = href;
      }, true);

      // handler راست‌کلیک
      addContextHandlerToCard(card);
    });

    // pointerdown — فقط به دکمهٔ چپ واکنش بدهیم تا راست‌کلیک باعث درگ نشود
    row.addEventListener('pointerdown', function (e) {
      if (e.pointerType === 'mouse' && e.button !== 0) return;
      pointerActive = true;
      activePointerId = e.pointerId;
      startX = e.clientX;
      startY = e.clientY;
      lastScrollLeft = row.scrollLeft;
      isDragging = false;
      try { row.setPointerCapture(activePointerId); } catch (_) {}
      row.classList.add('dragging');
      document.body.style.userSelect = 'none';
    }, { passive: false });

    row.addEventListener('pointermove', function (e) {
      if (!pointerActive || e.pointerId !== activePointerId) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      if (Math.abs(dx) > MOVE_THRESHOLD && Math.abs(dx) > Math.abs(dy)) {
        isDragging = true;
        targetScrollLeft = lastScrollLeft - dx * 1.2;
        if (!ticking) {
          ticking = true;
          requestAnimationFrame(function () {
            row.scrollLeft = targetScrollLeft;
            ticking = false;
          });
        }
        e.preventDefault && e.preventDefault();
        setChildPointerEventsDisabled(true);
      }
    }, { passive: false });

    function finishPointer() {
      if (!pointerActive) return;
      try { if (activePointerId !== null) row.releasePointerCapture(activePointerId); } catch (_) {}
      pointerActive = false;
      activePointerId = null;
      row.classList.remove('dragging');
      setChildPointerEventsDisabled(false);
      document.body.style.userSelect = '';
      if (isDragging) {
        suppressClick = true;
        clearTimeout(suppressTimer);
        suppressTimer = setTimeout(function () { suppressClick = false; }, SUPPRESS_MS);
      }
      isDragging = false;
    }

    // pointerup: اگر موس و دکمه غیر از چپ است فقط cleanup کن
    row.addEventListener('pointerup', function (e) {
      if (e.pointerType === 'mouse' && e.button !== 0) {
        finishPointer();
        return;
      }

      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      const moved = Math.hypot(dx, dy);
      const wasDragging = isDragging;

      finishPointer();

      if (!wasDragging && moved <= MOVE_THRESHOLD && !suppressClick) {
        const el = document.elementFromPoint(e.clientX, e.clientY);
        const card = el && el.closest ? el.closest('.product-card, .related-card') : null;
        if (card && !card.classList.contains('drag-disable')) {
          const href = card.getAttribute('data-href') || card.dataset.href;
          if (href) window.location.href = href;
        }
      }
    }, { passive: true });

    row.addEventListener('pointercancel', finishPointer);
    row.addEventListener('pointerleave', finishPointer);

    // سرکوب کلیک بلافاصله بعد از درگ
    row.addEventListener('click', function (e) {
      if (suppressClick) {
        e.stopImmediatePropagation();
        e.preventDefault();
      }
    }, true);

    // دسترسی کیبورد برای کارت‌های فوکوس‌شده
    row.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' || e.key === ' ') {
        const focused = document.activeElement;
        const card = focused && focused.closest ? focused.closest('.product-card, .related-card') : null;
        if (card) {
          const href = card.getAttribute('data-href') || card.dataset.href;
          if (href) {
            window.location.href = href;
            e.preventDefault();
          }
        }
      }
    });

  }); // forEach related-row


  // اگر در صفحه‌مان بخش new-products-grid هست، به کارت‌های آن هم handler راست‌کلیک اضافه کن
  document.querySelectorAll('.new-products-grid .product-card.related-card').forEach(function (card) {
    // جلوگیری از ghost image
    card.querySelectorAll('img').forEach(img => img.setAttribute('draggable', 'false'));

    // اگر data-href از inline onclick موجود نیست آن را استخراج کن
    if (!card.getAttribute('data-href')) {
      const onclick = card.getAttribute('onclick');
      if (onclick) {
        const m = onclick.match(/window\.location\.href\s*=\s*['"]([^'"]+)['"]/);
        if (m && m[1]) card.setAttribute('data-href', m[1]);
      }
    }

    addContextHandlerToCard(card);

    // و ایمن‌سازی تک‌کلیک
    card.addEventListener('pointerup', function (e) {
      if (e.pointerType === 'mouse' && e.button !== 0) return;
      if (card.classList.contains('drag-disable')) return;
      const href = card.getAttribute('data-href') || card.dataset.href;
      if (href) window.location.href = href;
    });
    card.addEventListener('click', function (e) {
      if (typeof e.button !== 'undefined' && e.button !== 0) return;
      if (card.classList.contains('drag-disable')) return;
      const href = card.getAttribute('data-href') || card.dataset.href;
      if (href) window.location.href = href;
    }, true);
  });

});
</script>
<script>
// Inline comment form submission
document.addEventListener('DOMContentLoaded', function(){
    const form = document.getElementById('inline-comment-form');
    if(!form) return;

    form.addEventListener('submit', function(e){
        e.preventDefault();
        const url = form.getAttribute('action');
        const text = document.getElementById('comment-text').value.trim();
        const rating = document.getElementById('rating').value;
        if(!text){
            alert('لطفاً متن نظر را وارد کنید.');
            return;
        }

        // send as FormData so Django form parsing works
        const formData = new FormData();
        formData.append('text', text);
        formData.append('rating', rating);
        // include csrf token input if present in the form
        const csrfInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
        if(csrfInput) formData.append('csrfmiddlewaretoken', csrfInput.value);

        fetch(url, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(res => {
            console.log('AJAX response status:', res.status, 'ok:', res.ok);
            if(!res.ok) {
                res.text().then(txt => {
                    console.error('Response not ok. Status:', res.status, 'Body:', txt);
                });
                throw new Error('خطا در ارسال نظر');
            }
            return res.json();
        })
        .then(data => {
            console.log('AJAX response data:', data);
            window.location.reload();
        })
        .catch(err => {
            console.error('AJAX error:', err);
            alert('ثبت نظر ناموفق بود. دوباره تلاش کنید.');
        });
    });
});
</script>
{% endblock %}
