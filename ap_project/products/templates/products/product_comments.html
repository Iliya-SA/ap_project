{% extends 'store/base.html' %}
{% block title %}نظرات محصول: {{ product.name }}{% endblock %}
{% block content %}
<style>
    body {
        background-color: #f8f9fa;
        font-family: Tahoma, Arial, sans-serif;
        direction: rtl;
        padding: 20px;
    }
    h2 {
        margin-bottom: 30px;
        color: #333;
    }
    .comment {
        background-color: white;
        border-radius: 8px;
        padding: 15px 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .comment .user-name {
        font-size: 1.2rem;
        color: #007bff;
        font-weight: bold;
    }
    .star-icon {
        color: #fbc02d;
        font-size: 20px;
        vertical-align: middle;
        margin-left: 8px;
    }
    .rating {
        color: #ffc107;
        font-weight: bold;
        margin-left: 10px;
    }
    .comment-text {
        margin-top: 10px;
        font-size: 1rem;
        color: #444;
    }
    .comment-date {
        margin-top: 8px;
        font-size: 0.85rem;
        color: #777;
    }
    .back-btn {
        margin-top: 25px;
    }
</style>
<div class="container mt-4">
    <div class="d-flex justify-content-start mb-3" style="direction: rtl;">
        <a href="{% url 'product-detail' product.pk %}" class="btn btn-outline-secondary" style="min-width:120px; text-align:right;">&larr; بازگشت به صفحه محصول</a>
    </div>
    <h2>نظرات محصول: {{ product.name }}</h2>
    {% if comments %}
        {% for comment in comments %}
            <div class="comment position-relative" dir="rtl">
                {% if user.is_authenticated and comment.user.id == user.id %}
                    <form method="post" action="{% url 'delete-comment' comment.pk %}" class="delete-comment-form" style="position:absolute; left:12px; top:12px; z-index:2;">
                        {% csrf_token %}
                        <!-- برای کاربران بدون JS -->
                        <noscript>
                            <button type="submit" class="btn btn-sm btn-danger">حذف</button>
                        </noscript>

                        <!-- دکمه‌ی AJAX (type=button تا فرم بصورت عادی submit نشود) -->
                        <button type="button" class="btn btn-sm btn-danger ajax-delete-comment"
                                data-url="{% url 'delete-comment' comment.pk %}">
                            حذف
                        </button>
                    </form>
                {% endif %}
                <div class="d-flex align-items-center mb-2 justify-content-start" style="text-align:right;">
                    <span class="star-icon ms-2">★ {{ comment.rating }}</span>
                    <span class="user-name">{{ comment.user.user.first_name }} {{ comment.user.user.last_name }}</span>
                </div>
                <div class="comment-text mb-1">{{ comment.text }}</div>
                <div class="comment-date">{{ comment.created_at|date:"Y/m/d H:i" }}</div>
            </div>
        {% endfor %}
    {% else %}
        <p>هیچ نظری برای این محصول ثبت نشده است.</p>
    {% endif %}
</div>

<!-- اسکریپت AJAX حذف نظر (یکبار قرار گیرد) -->
<script>
// AJAX delete via button click — avoids any submit-based handlers so no reload
document.addEventListener('DOMContentLoaded', function () {
    document.addEventListener('click', async function (ev) {
        const btn = ev.target.closest && ev.target.closest('.ajax-delete-comment');
        if (!btn) return;

        ev.preventDefault();
        ev.stopImmediatePropagation(); // try to stop other click handlers

        if (!confirm('آیا از حذف نظر خود مطمئن هستید؟')) return;

        const url = btn.getAttribute('data-url');
        // try to find CSRF token from the same form
        const form = btn.closest('form');
        const csrfInput = form ? form.querySelector('input[name="csrfmiddlewaretoken"]') : null;
        const csrf = csrfInput ? csrfInput.value : null;

        // disable button to avoid double clicks
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = 'در حال حذف...';

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    ...(csrf ? {'X-CSRFToken': csrf} : {})
                }
            });

            if (!res.ok) {
                let txt = '';
                try { txt = await res.text(); } catch(_) {}
                throw new Error('حذف ناموفق: ' + res.status + ' ' + txt);
            }

            // حذف DOM کامنت
            const commentDiv = btn.closest('.comment') || btn.closest('.comment-item') || form.closest('.comment');
            if (commentDiv) commentDiv.remove();

        } catch (err) {
            console.error('AJAX delete error:', err);
            alert('حذف نظر ناموفق بود. دوباره تلاش کنید.');
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }, true); // use capture to be early
});
</script>

{% endblock %}
