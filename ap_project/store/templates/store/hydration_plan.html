{% extends 'store/base.html' %}
{% load static %}
{% load humanize %}
{% block title %}طرح آبرسان - روتین پوستی{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-start mb-3" style="direction: rtl;">
    <a href="{% url 'routine' %}" class="btn btn-outline-secondary" style="min-width:120px; text-align:right;">&larr; بازگشت</a>
  </div>

  <h2 class="mb-4">{{ plan_name }}</h2>

  {% for row in rows %}
    <section class="mb-5">
      <h5 class="mb-2">{{ row.category }}</h5>

      {% if row.category == 'پاک کننده' %}
        <p class="text-muted">برای شروع یک روتین پوستی سالم، همیشه با پاک‌کننده آغاز کنید! صبح و شب صورت خود را با یک فوم یا ژل ملایم بشویید تا آلودگی، چربی و آرایش از پوستتان پاک شود. آب ولرم بهترین انتخاب است و بعد از شست‌وشو، پوست را با حوله تمیز به آرامی خشک کنید. این مرحله کمک می‌کند محصولات بعدی بهتر جذب شوند و پوستتان همیشه شاداب بماند.</p>
      {% elif row.category == 'سرم' %}
        <p class="text-muted">سرم‌ها غلظت بالایی از مواد مؤثر دارند و بعد از تونر استفاده می‌شوند تا مشکلات خاص پوست مثل لک، چین‌وچروک یا خشکی را هدف قرار دهند. چند قطره سرم را روی صورت و گردن بزنید و با نوک انگشتان به آرامی ماساژ دهید تا جذب شود. صبح و شب استفاده کنید تا پوستتان شفاف‌تر و سالم‌تر شود.</p>
      {% elif row.category == 'روشن کننده' %}
        <p class="text-muted">محصولات روشن‌کننده برای یکنواخت کردن رنگ پوست و کاهش لک‌ها مناسب‌اند. بعد از سرم و قبل از مرطوب‌کننده، مقدار کمی از روشن‌کننده را روی نقاط مورد نظر یا کل صورت بزنید. استفاده منظم، به مرور زمان باعث شفافیت و درخشندگی پوست می‌شود. حتماً در کنار آن از ضدآفتاب استفاده کنید.</p>
      {% elif row.category == 'تونر' %}
        <p class="text-muted">بعد از پاکسازی، تونر را فراموش نکنید! تونر به بازگرداندن تعادل pH پوست کمک می‌کند و منافذ را برای جذب بهتر سرم و مرطوب‌کننده آماده می‌سازد. مقدار کمی تونر را روی پنبه یا کف دست بریزید و به آرامی روی صورت بزنید. صبح و شب بعد از شست‌وشو استفاده شود تا پوستتان همیشه تازه و آماده باشد.</p>
      {% elif row.category == 'مرطوب‌کننده' %}
        <p class="text-muted">مرطوب‌کننده دوست همیشگی پوست شماست! بعد از تونر و سرم، مقدار کافی مرطوب‌کننده را روی صورت و گردن بزنید و به آرامی ماساژ دهید تا جذب شود. این کار را صبح و شب انجام دهید تا پوستتان نرم، لطیف و درخشان بماند. اگر پوست خیلی خشکی دارید، در طول روز هم می‌توانید تمدید کنید.</p>
      {% elif row.category == 'ضدآفتاب' %}
        <p class="text-muted">ضدآفتاب مهم‌ترین بخش روتین روزانه است! هر روز صبح، حتی در روزهای ابری یا داخل خانه، مقدار کافی ضدآفتاب را به کل صورت و گردن بزنید. ۳۰ دقیقه قبل از خروج از منزل استفاده کنید و اگر مدت طولانی بیرون هستید یا عرق کردید، هر ۲ تا ۳ ساعت تمدید کنید. با این کار از پوستتان در برابر پیری زودرس و آسیب‌های آفتاب محافظت می‌کنید.</p>
      {% else %}
        <p class="text-muted">استفادهٔ روزانه متناسب با نیاز (مثلاً کرم روز/شب)؛ معمولاً بعد از سرم و مرطوب‌کننده اعمال می‌شود.</p>
      {% endif %}

      <div class="related-row d-flex overflow-auto gap-3 py-2">
        {% for product in row.products %}
          <div class="product-card related-card flex-shrink-0 text-center p-2 position-relative"
               style="min-width:210px; width:210px; height:230px; cursor:pointer; padding-bottom:60px;"
               data-href="{% url 'product-detail' product.pk %}">
              <img src="{{ product.image.url }}" alt="{{ product.name }}">
              <h6 class="mt-2">{{ product.name }}</h6>
              <p class="text-success fw-bold mb-1 position-absolute w-100 price-tag" style="font-size:17px;">
                  {{ product.price|floatformat:0|intcomma }} تومان
              </p>
              <div class="d-flex justify-content-between align-items-center position-absolute w-100 bottom-row" style="padding:0 10px;">
                  <span>
                      {% if product.stock > 0 %}
                          <span class="badge bg-success">موجود</span>
                      {% else %}
                          <span class="badge bg-danger">ناموجود</span>
                      {% endif %}
                  </span>
                  <span class="d-flex align-items-center gap-1">
                      <span class="star">&#9733;</span>
                      <span class="rating-val">{{ product.avg_rating|default:0|floatformat:1 }}</span>
                  </span>
              </div>
          </div>
        {% endfor %}
      </div>
    </section>
  {% endfor %}
</div>

<style>
    /* جلوگیری از انتخاب متن هنگام درگ */
    .related-row, .related-row * {
        user-select: none !important;
        -webkit-user-select: none !important;
        -ms-user-select: none !important;
    }

    /* کمک برای درگ و رفتار لمسی */
    .related-row {
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
        cursor: grab;
    }
    .related-row.dragging { cursor: grabbing; }

    /* اطمینان از اینکه کارت‌ها قابل کلیک هستند ولی هنگام درگ غیرفعال می‌شوند */
    .product-card, .related-card { -webkit-user-select: none; user-select: none; }
    .product-card.drag-disable, .related-card.drag-disable { pointer-events: none !important; }

    /* کارت‌های مشابه (ظاهر و هاور و تصویر داخل کادر) */
    .related-card img,
    .product-card.related-card img {
        height: 120px;
        object-fit: contain;
        border-radius: 8px;
        background-color: #fff;
        border: 1px solid #ddd;
        padding: 8px;
        width: 100%;
        display: block;
    }

    .related-card,
    .product-card.related-card {
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        transition: box-shadow 0.3s ease, transform 0.18s ease;
        background: #fff;
        overflow: hidden;
    }

    .related-card:hover,
    .product-card.related-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateY(-4px);
    }

    .product-card.related-card h6 {
        margin-top: .5rem;
        margin-bottom: .25rem;
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .product-card.related-card .price-tag {
        bottom: 38px;
        left: 0;
        margin: 0;
        font-size: 17px;
    }

    .product-card.related-card .bottom-row {
        bottom: 10px;
        left: 0;
        padding: 0 10px;
    }

    .product-card.related-card .badge { font-size: 13px; }
    .product-card.related-card .star { color: #fbc02d; font-size: 16px; }
    .product-card.related-card .rating-val { font-size: 14px; }

    /* small enhancement: smoother momentum on iOS */
    .related-row { -webkit-overflow-scrolling: touch; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {

  // باز کردن لینک در تب جدید (اول window.open، سپس fallback با <a>)
  function openInNewTab(url) {
    try {
      const w = window.open(url, '_blank', 'noopener,noreferrer');
      if (w) return true;
    } catch (_) {}
    try {
      const a = document.createElement('a');
      a.href = url;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      const ev = new MouseEvent('click', { bubbles: true, cancelable: true, view: window });
      a.dispatchEvent(ev);
      a.remove();
      return true;
    } catch (_) { return false; }
  }

  // اضافه کردن handler راست‌کلیک محافظت‌شده به هر کارت
  function addContextHandlerToCard(card) {
    if (!card || card._rc_handler_added) return;
    card._rc_handler_added = true;

    card.addEventListener('contextmenu', function (e) {
      // بستن منوی پیش‌فرض و جلوگیری از اجرای handlerهای دیگر
      e.preventDefault();
      e.stopImmediatePropagation();
      e.stopPropagation();

      // اگر کارت غیرفعال است یا ردیف در حالت درگ/سرکوب کلیک است، کاری انجام نده
      const row = card.closest('.related-row');
      let isDragging = false, suppressClick = false;
      if (row && typeof row.__dragState !== 'undefined') {
        try {
          isDragging = !!row.__dragState.isDragging;
          suppressClick = !!row.__dragState.suppressClick;
        } catch (_) {}
      }
      if (isDragging || suppressClick || card.classList.contains('drag-disable')) return;

      // استخراج لینک از data-href یا onclick inline
      let href = card.getAttribute('data-href') || card.dataset.href;
      if (!href) {
        const onclick = card.getAttribute('onclick');
        if (onclick) {
          const m = onclick.match(/window\.location\.href\s*=\s*['"]([^'"]+)['"]/);
          if (m && m[1]) href = m[1];
        }
      }
      if (!href) return;

      if (card._rc_opened) return;
      card._rc_opened = true;

      openInNewTab(href);

      setTimeout(() => { card._rc_opened = false; }, 300);
    }, false);
  }

  // پیاده‌سازی درگ-اسکرول با pointer events برای هر .related-row
  document.querySelectorAll('.related-row').forEach(function (row) {
    const MOVE_THRESHOLD = 8;
    const SUPPRESS_MS = 220;

    let pointerActive = false;
    let activePointerId = null;
    let startX = 0, startY = 0;
    let lastScrollLeft = 0;
    let isDragging = false;
    let suppressClick = false;
    let suppressTimer = null;
    let ticking = false;
    let targetScrollLeft = 0;

    // expose state برای دسترسی handlerهای contextmenu
    Object.defineProperty(row, '__dragState', {
      get: function () { return { isDragging: isDragging, suppressClick: suppressClick }; },
      configurable: true
    });

    // جلوگیری از ghost image برای تصاویر
    row.querySelectorAll('img').forEach(img => img.setAttribute('draggable', 'false'));

    function setChildPointerEventsDisabled(disabled) {
      row.querySelectorAll('.product-card, .related-card').forEach(function (c) {
        c.classList.toggle('drag-disable', disabled);
      });
    }

    // ثبت listenerها برای کارت‌ها (تک‌کلیک امن و contextmenu)
    row.querySelectorAll('.product-card, .related-card').forEach(function (card) {
      // pointerup: فقط وقتی دکمهٔ چپ است یا لمسی
      card.addEventListener('pointerup', function (e) {
        if (e.pointerType === 'mouse' && e.button !== 0) return;
        if (isDragging || suppressClick) return;
        const href = card.getAttribute('data-href') || card.dataset.href;
        if (href) window.location.href = href;
      });

      // fallback click
      card.addEventListener('click', function (e) {
        if (isDragging || suppressClick) {
          e.preventDefault();
          e.stopImmediatePropagation();
          return;
        }
        if (typeof e.button !== 'undefined' && e.button !== 0) return;
        const href = card.getAttribute('data-href') || card.dataset.href;
        if (href) window.location.href = href;
      }, true);

      // handler راست‌کلیک محافظت‌شده
      addContextHandlerToCard(card);
    });

    // pointerdown — فقط به دکمهٔ چپ واکنش نشان بده (تا راست‌کلیک اختلال ایجاد نکند)
    row.addEventListener('pointerdown', function (e) {
      if (e.pointerType === 'mouse' && e.button !== 0) return;
      pointerActive = true;
      activePointerId = e.pointerId;
      startX = e.clientX;
      startY = e.clientY;
      lastScrollLeft = row.scrollLeft;
      isDragging = false;
      try { row.setPointerCapture(activePointerId); } catch (_) {}
      row.classList.add('dragging');
      document.body.style.userSelect = 'none';
    }, { passive: false });

    row.addEventListener('pointermove', function (e) {
      if (!pointerActive || e.pointerId !== activePointerId) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      if (Math.abs(dx) > MOVE_THRESHOLD && Math.abs(dx) > Math.abs(dy)) {
        isDragging = true;
        targetScrollLeft = lastScrollLeft - dx * 1.2;
        if (!ticking) {
          ticking = true;
          requestAnimationFrame(function () {
            row.scrollLeft = targetScrollLeft;
            ticking = false;
          });
        }
        e.preventDefault && e.preventDefault();
        setChildPointerEventsDisabled(true);
      }
    }, { passive: false });

    function finishPointer() {
      if (!pointerActive) return;
      try { if (activePointerId !== null) row.releasePointerCapture(activePointerId); } catch (_) {}
      pointerActive = false;
      activePointerId = null;
      row.classList.remove('dragging');
      setChildPointerEventsDisabled(false);
      document.body.style.userSelect = '';
      if (isDragging) {
        suppressClick = true;
        clearTimeout(suppressTimer);
        suppressTimer = setTimeout(function () { suppressClick = false; }, SUPPRESS_MS);
      }
      isDragging = false;
    }

    row.addEventListener('pointerup', function (e) {
      // اگر موس و دکمه غیر از چپ است فقط cleanup کن
      if (e.pointerType === 'mouse' && e.button !== 0) {
        finishPointer();
        return;
      }

      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      const moved = Math.hypot(dx, dy);
      const wasDragging = isDragging;

      finishPointer();

      if (!wasDragging && moved <= MOVE_THRESHOLD && !suppressClick) {
        const el = document.elementFromPoint(e.clientX, e.clientY);
        const card = el && el.closest ? el.closest('.product-card, .related-card') : null;
        if (card && !card.classList.contains('drag-disable')) {
          const href = card.getAttribute('data-href') || card.dataset.href;
          if (href) window.location.href = href;
        }
      }
    }, { passive: true });

    row.addEventListener('pointercancel', finishPointer);
    row.addEventListener('pointerleave', finishPointer);

    // سرکوب کلیک بلافاصله بعد از درگ
    row.addEventListener('click', function (e) {
      if (suppressClick) {
        e.stopImmediatePropagation();
        e.preventDefault();
      }
    }, true);

    // دسترسی کیبورد برای کارت‌های فوکوس‌شده
    row.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' || e.key === ' ') {
        const focused = document.activeElement;
        const card = focused && focused.closest ? focused.closest('.product-card, .related-card') : null;
        if (card) {
          const href = card.getAttribute('data-href') || card.dataset.href;
          if (href) {
            window.location.href = href;
            e.preventDefault();
          }
        }
      }
    });

  }); // forEach row
});
</script>

{% endblock %}
