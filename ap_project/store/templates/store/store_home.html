{% extends "store/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}صفحه اصلی فروشگاه{% endblock %}

{% block content %}
<section>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>جدیدترین محصولات</h5>
    <a href="/products" class="btn btn-sm btn-outline-primary">مشاهده همه</a>
    </div>
    <div class="row">
        {% for product in new_products %}
        <div class="col-md-3 col-sm-6">
            <div class="product-card">
                                <img src="{{ product.image.url }}" alt="{{ product.name }}" />
                                <h6>{{ product.name }}</h6>
                                <p class="text-success fw-bold" style="color: #1b5e20;">
                                        {{ product.price|intcomma }} تومان
                                </p>
                                {% if product.stock > 0 %}
                                    <p class="text-success small mb-1">موجود</p>
                                {% else %}
                                    <p class="text-danger small mb-1">ناموجود</p>
                                {% endif %}
                                <p class="mb-2 d-flex align-items-center gap-1">
                                        <span style="color: #fbc02d; font-size: 18px;">&#9733;</span>
                                        <span>{{ product.avg_rating|default:0|floatformat:1 }}</span>
                                </p>
                                <a href="{% url 'product-detail' product.pk %}" class="btn btn-sm btn-primary">مشاهده</a>
            </div>
        </div>
        {% empty %}
        <p>محصولی یافت نشد.</p>
        {% endfor %}
    </div>
</section>

<section class="mt-4">
    <h5>محصولات پیشنهادی برای پوست شما {% if user.profile.skin_type %}({{ user.profile.skin_type }}){% endif %}</h5>
    <div>
        {% if not user.is_authenticated %}
            <p>ابتدا وارد حساب کاربری خود شوید</p>
        {% elif recommended_products %}
            <div class="related-row d-flex overflow-auto gap-3 py-2 mb-3" style="user-select:none;">
                {% for product in recommended_products %}
                    <div class="product-card flex-shrink-0" style="min-width:210px; width:210px;">
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" style="height:140px; object-fit:cover; width:100%; border-radius:8px;" />
                        <h6 class="mt-2">{{ product.name }}</h6>
                        <p class="text-success fw-bold mb-1">{{ product.price|intcomma }} تومان</p>
                        {% if product.stock > 0 %}
                            <p class="text-success small mb-1">موجود</p>
                        {% else %}
                            <p class="text-danger small mb-1">ناموجود</p>
                        {% endif %}
                        <div class="mb-2 d-flex align-items-center gap-1">
                            <span class="star-icon" style="color: #fbc02d; font-size: 18px;">&#9733;</span>
                            <span>{{ product.avg_rating|default:0|floatformat:1 }}</span>
                        </div>
                        <a href="{% url 'product-detail' product.pk %}" class="btn btn-sm btn-primary">مشاهده</a>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>محصول پیشنهادی موجود نیست.</p>
        {% endif %}
    </div>
</section>

<section class="mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>محصولات فصل {{ season }}</h5>
        <a href="{% url 'seasonal-products' %}" class="btn btn-sm btn-outline-primary">مشاهده همه محصولات فصل</a>
    </div>
    <div>
        {% if seasonal_products %}
            <div class="related-row d-flex overflow-auto gap-3 py-2 mb-3" style="user-select:none;">
                {% for product in seasonal_products %}
                    <div class="product-card flex-shrink-0" style="min-width:210px; width:210px;">
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" style="height:140px; object-fit:cover; width:100%; border-radius:8px;" />
                        <h6 class="mt-2">{{ product.name }}</h6>
                        <p class="text-success fw-bold mb-1">{{ product.price|intcomma }} تومان</p>
                        {% if product.stock > 0 %}
                            <p class="text-success small mb-1">موجود</p>
                        {% else %}
                            <p class="text-danger small mb-1">ناموجود</p>
                        {% endif %}
                        <p class="mb-2 d-flex align-items-center gap-1">
                            <span style="color: #fbc02d; font-size: 18px;">&#9733;</span>
                            <span>{{ product.avg_rating|default:0|floatformat:1 }}</span>
                        </p>
                        {% if user.is_authenticated %}
                            <a href="{% url 'product-detail' product.pk %}" class="btn btn-sm btn-primary">مشاهده</a>
                        {% else %}
                            <a href="{% url 'signin' %}?next={% url 'product-detail' product.pk %}" class="btn btn-sm btn-primary">مشاهده</a>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>محصول فصلی‌ای یافت نشد.</p>
        {% endif %}
    </div>
</section>

</section>

<section class="mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>محصولات مورد علاقه شما</h5>
        <a href="{% url 'favorites-list' %}" class="btn btn-sm btn-outline-primary">نمایش همه علاقه‌مندی‌ها</a>
    </div>

    <div>
        {% if not user.is_authenticated %}
            <p>ابتدا وارد حساب کاربری خود شوید</p>
        {% elif liked_favorites %}
            <div class="related-row d-flex overflow-auto gap-3 py-2 mb-3" style="user-select:none;">
                {% for product in liked_favorites|slice:":10" %}
                    <div class="product-card flex-shrink-0" style="min-width:210px; width:210px;">
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" style="height:140px; object-fit:cover; width:100%; border-radius:8px;" />
                        <h6 class="mt-2">{{ product.name }}</h6>
                        <p class="text-success fw-bold mb-1">{{ product.price|intcomma }} تومان</p>
                        {% if product.stock > 0 %}
                            <p class="text-success small mb-1">موجود</p>
                        {% else %}
                            <p class="text-danger small mb-1">ناموجود</p>
                        {% endif %}
                        <div class="mb-2 d-flex align-items-center gap-1">
                            <span class="star-icon" style="color: #fbc02d; font-size: 18px;">&#9733;</span>
                            <span>{{ product.avg_rating|default:0|floatformat:1 }}</span>
                        </div>
                        <a href="{% url 'product-detail' product.pk %}" class="btn btn-sm btn-primary">مشاهده</a>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>محصول مورد علاقه‌ای یافت نشد.</p>
        {% endif %}
    </div>

    <!-- recent_purchases grid removed — favorites shown in horizontal scroller above -->
</section>
{% endblock %}
        <style>
        .related-row, .related-row * {
            user-select: none !important;
            -webkit-user-select: none !important;
            -ms-user-select: none !important;
        }
        </style>
        <script>
        // Enable drag-to-scroll for all .related-row elements, and prevent selection while dragging
        document.addEventListener('DOMContentLoaded', function(){
            document.querySelectorAll('.related-row').forEach(function(row){
                let isDown = false, startX, scrollLeft;
                row.addEventListener('mousedown', function(e){
                    isDown = true;
                    row.classList.add('dragging');
                    startX = e.pageX - row.offsetLeft;
                    scrollLeft = row.scrollLeft;
                    document.body.style.userSelect = 'none';
                });
                row.addEventListener('mouseleave', function(){
                    isDown = false;
                    row.classList.remove('dragging');
                    document.body.style.userSelect = '';
                });
                row.addEventListener('mouseup', function(){
                    isDown = false;
                    row.classList.remove('dragging');
                    document.body.style.userSelect = '';
                });
                row.addEventListener('mousemove', function(e){
                    if(!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - row.offsetLeft;
                    const walk = (x - startX) * 1.2; // scroll speed
                    row.scrollLeft = scrollLeft - walk;
                });
                // Touch support
                row.addEventListener('touchstart', function(e){
                    isDown = true;
                    startX = e.touches[0].pageX - row.offsetLeft;
                    scrollLeft = row.scrollLeft;
                    document.body.style.userSelect = 'none';
                });
                row.addEventListener('touchend', function(){
                    isDown = false;
                    document.body.style.userSelect = '';
                });
                row.addEventListener('touchmove', function(e){
                    if(!isDown) return;
                    const x = e.touches[0].pageX - row.offsetLeft;
                    const walk = (x - startX) * 1.2;
                    row.scrollLeft = scrollLeft - walk;
                });
            });
        });
        </script>
